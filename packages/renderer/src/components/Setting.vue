<template>
  <a-page-header
      title="è®¾ç½®"
      @back="router.back()"
  />
  <a-card id="4399" title="é…å¥—ç”¨æˆ·è„šæœ¬">
    ç”±äº 4399 ç­‰ç«™ç‚¹ä¸ºçœŸå®æ¸¸æˆé¡µé¢å¢åŠ äº† Referer é™åˆ¶ï¼Œå› æ­¤æ— æ³•ç›´æ¥åœ¨æµè§ˆå™¨ä¸­è®¿é—®æºç«™çœŸå®é¡µé¢æ’­æ”¾æ¸¸æˆï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…é…å¥—ç”¨æˆ·è„šæœ¬ï¼š
    <br/>
    ï¼ˆ1ï¼‰åœ¨æµè§ˆå™¨ä¸­å®‰è£… <a @click="shell.openExternal('https://www.tampermonkey.net/')">æ²¹çŒ´ï¼ˆTamperMonkeyï¼‰</a>æˆ– <a
      @click="shell.openExternal('https://violentmonkey.github.io/get-it/')">æš´åŠ›çŒ´ï¼ˆViolentMonkeyï¼‰</a>æ‹“å±•ï¼›
    <br/>
    ï¼ˆ2ï¼‰è®¿é—® <a
      @click="shell.openExternal('https://greasyfork.org/zh-CN/scripts/444989-flash-collector-for-4399')">GreasyFork
    è„šæœ¬é¡µé¢</a> æˆ– <a
      @click="shell.openExternal('https://github.com/Cnotech/flash-collector/raw/master/user-script/flash-collector-script.user.js')">GitHub
    ä»“åº“è„šæœ¬ç›´é“¾</a>ï¼Œå®‰è£…è„šæœ¬ã€‚
  </a-card>
  <br/>
  <a-card title="å¯åŠ¨æµè§ˆå™¨">
    <a-space direction="vertical">
      <p>åœ¨æœ¬åœ°è¿è¡Œæ¸¸æˆå¯èƒ½éœ€è¦æµè§ˆå™¨å¯¹ç›¸åº”å°æ¸¸æˆæ’­æ”¾æ’ä»¶çš„æ”¯æŒï¼Œè¯·å‚è€ƒæˆ‘ä»¬æä¾›çš„<a
          @click="shell.openExternal('https://github.com/Cnotech/flash-collector#æµè§ˆå™¨å…¼å®¹æ€§')">æµè§ˆå™¨å…¼å®¹æ€§è¡¨æ ¼</a>é€‰æ‹©å¯åŠ¨æµè§ˆå™¨ï¼š
      </p>
      <a-space>
        <span style="margin-right: 12.5px">Flashï¼š</span>
        <a-select v-model:value="browser.flash.name" :options="flashBrowserList" class="browser-selector"
                  @change="onChangeBrowser('flash')"></a-select>
        <span class="browser-location">{{ browser.flash.p }}</span>
      </a-space>
      <a-space>
        <span style="margin-right: 12px">Unityï¼š</span>
        <a-select v-model:value="browser.unity.name" :options="unityBrowserList" class="browser-selector"
                  @change="onChangeBrowser('unity')"></a-select>
        <span class="browser-location">{{ browser.unity.p }}</span>
      </a-space>
      <a-space>
        <span>HTML5ï¼š</span>
        <a-select v-model:value="browser.h5.name" :options="h5BrowserList" class="browser-selector"
                  @change="onChangeBrowser('h5')"></a-select>
        <span class="browser-location">{{ browser.h5.p }}</span>
      </a-space>
    </a-space>
  </a-card>
  <br/>
  <a-card title="æ™ºèƒ½å—…æ¢">
    <a-space direction="vertical">
      <p>æ­¤åŠŸèƒ½å¯ä»¥å¸®åŠ©ä¸‹è½½å¼‚æ­¥åŠ è½½çš„ Flash å°æ¸¸æˆï¼Œå¯ç”¨åå½“æ‚¨ä½¿ç”¨â€œæºç«™æ’­æ”¾â€æ—¶ Flash Collector
        ä¼šç›‘å¬æµè§ˆå™¨çš„èµ„æºè¯·æ±‚å¹¶å°†è¯·æ±‚çš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚</p>
      <small>æ³¨æ„ï¼š</small>
      <small>1ã€éœ€è¦æµè§ˆå™¨å®ç° Chrome DevTools Protocol ï¼ˆCDPï¼‰ æ‰èƒ½è¿›è¡Œå—…æ¢ï¼Œå—…æ¢è¿‡ç¨‹ä¸­æµè§ˆå™¨å¯èƒ½ä¼šå¡é¡¿ã€‚</small>
      <small>2ã€å—…æ¢è¿‡ç¨‹ä¸­è¯·å°½å¯èƒ½æ¸¸ç©å…¨éƒ¨å…³å¡ä»¥ä¿è¯ç¼ºå¤±çš„æ–‡ä»¶è¢«å—…æ¢å…¨é¢ï¼›å¦‚æœå—…æ¢ç»“æŸåä»ä¸èƒ½åœ¨æœ¬åœ°æ­£ç¡®æ’­æ”¾è¯´æ˜è¿™ä¸ª Flash
        å¯èƒ½ä½¿ç”¨äº†ç«™ç‚¹é˜²ç›—ç”¨ç­–ç•¥ï¼Œå»ºè®®è¿˜æ˜¯åœ¨çº¿ç©ğŸ˜¥ã€‚</small>
      <a-switch v-model:checked="smartSniffing.enable" checked-children="å¯ç”¨" un-checked-children="å…³é—­"
                @change="checkSmartSniffing"/>
      <a-space v-if="smartSniffing.enable" size="large">
        è°ƒè¯•ç«¯å£ï¼š
        <a-input v-model:value="smartSniffing.port" style="width: 140px"></a-input>
      </a-space>
      <template v-if="smartSniffing.enable&&browser.flash.node.trait.debug==='unknown'">
        å¯åŠ¨å‚æ•°ï¼š
        <a-input v-model:value="smartSniffing.arg"
                 :placeholder="`è¾“å…¥${browser.flash.name}ä¸å¸¦ç«¯å£å·çš„ Chrome DevTools Protocol å¯åŠ¨å‚æ•°ï¼Œä¾‹å¦‚ --remote-debugging-port=`"></a-input>
        <a-button type="link"
                  @click="shell.openExternal('https://www.npmjs.com/package/chrome-remote-interface#Setup')">CDPå‚æ•°å‚è€ƒ
        </a-button>
      </template>
    </a-space>
  </a-card>
  <br/>
  <a-card title="è‡ªåŠ¨å¤‡ä»½è¿›åº¦">
    <p>åœ¨å¯åŠ¨æ¸¸æˆæ—¶è‡ªåŠ¨å¤‡ä»½ä¸Šæ¬¡æ¸¸æˆè¿›åº¦ï¼Œè‹¥é¢‘ç¹å‡ºé”™è¯·<a
        @click="shell.openExternal('https://github.com/Cnotech/flash-collector/issues')">æäº¤
      issue </a>ç„¶åæš‚æ—¶å…³é—­æ­¤åŠŸèƒ½ã€‚</p>
    <a-switch v-model:checked="enableProgressBackup" checked-children="å¯ç”¨" un-checked-children="ç¦ç”¨"/>
  </a-card>
  <br/>
  <a-card title="è¿è¡Œåº“æ£€æŸ¥">
    <p>åœ¨å¯åŠ¨æ¸¸æˆæ—¶è‡ªåŠ¨æ£€æŸ¥ç›¸åº”è¿è¡Œåº“æ˜¯å¦å·²ç»å®‰è£…ï¼Œè‹¥é¢‘ç¹å‡ºé”™è¯·<a
        @click="shell.openExternal('https://github.com/Cnotech/flash-collector/issues')">æäº¤
      issue </a>ç„¶åæš‚æ—¶å…³é—­æ­¤åŠŸèƒ½ã€‚</p>
    <a-switch v-model:checked="libCheck" checked-children="å¯ç”¨" un-checked-children="ç¦ç”¨"/>
  </a-card>
  <br/>
  <a-card title="æœç´¢å¼•æ“">
    <p>è‡ªå®šä¹‰é¦–é¡µæœç´¢æ¡†æ‰€ä½¿ç”¨çš„æœç´¢å¼•æ“ã€‚</p>
    <a-space>
      <a-select v-model:value="site" :options="siteOptions" style="width: 120px"></a-select>
      <a-select v-model:value="method" :options="methodOptions" style="width: 140px"></a-select>
    </a-space>
  </a-card>
  <br/>
  <a-card title="æ¸¸æˆæœåŠ¡ç«¯å£">
    è‹¥å‡ºç°ç«¯å£å†²çªå¯¼è‡´æ— æ³•åœ¨æµè§ˆå™¨ä¸­è®¿é—®æœ¬åœ°æ¸¸æˆæœåŠ¡å™¨è¯·å°è¯•ä¿®æ”¹ç«¯å£ï¼Œä½†æ˜¯æ³¨æ„æ›´æ”¹ç«¯å£å¯èƒ½ä¼šå¯¼è‡´ä¸¢å¤±æ¸¸æˆè¿›åº¦ï¼
    <br/><br/>
    <a-space>
      <a-input v-model:value="port" style="width: 100%"/>
      <a-button :type="oldPort==port?'default':'primary'" @click="restart">ç«‹å³åº”ç”¨</a-button>
    </a-space>
  </a-card>
  <br/>
  <a-card title="è®¸å¯ä¸æ¡æ¬¾">
    æ­¤è½¯ä»¶å…è´¹è·å–å¹¶åœ¨ <a @click="shell.openExternal('https://github.com/Cnotech/flash-collector')">Cnotech/flash-collector</a>
    ä»¥
    MPL-2.0 åè®®å¼€æºï¼Œå¦‚æœæ‚¨æ‹¥æœ‰ GitHub è´¦å·æ¬¢è¿ç‚¹ä¸ª Star â­ï¸ æ¥è¡¨ç¤ºé¼“åŠ±ï¼›å¦‚æœæ‚¨æ˜¯é€šè¿‡ä»˜è´¹çš„æ–¹å¼è·å¾—çš„è¯·ç«‹å³ç”³è¯·é€€æ¬¾å¹¶å·®è¯„å–å®¶ã€‚
    <br/><br/>
    ä½¿ç”¨æ­¤è½¯ä»¶åŠå…¶ç›¸å…³å†…å®¹å³è¡¨ç¤ºæ‚¨åŒæ„ä¸‹è¿°æ¡æ¬¾ï¼š
    <br/>
    ï¼ˆ1ï¼‰è¯¥ä»“åº“çš„ä»£ç ä»¥åŠç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆåŒ…æ‹¬æœ¬è½¯ä»¶ï¼‰ä»…ä¾›ä¸ªäººäº¤æµå­¦ä¹ ä½¿ç”¨ï¼Œä½œè€…ä¸å¯¹ä»¥ä»»ä½•å½¢å¼ä½¿ç”¨è¿™äº›ä»£ç æˆ–å¯æ‰§è¡Œæ–‡ä»¶é€ æˆçš„åæœè´Ÿè´£ï¼›
    <br/>
    ï¼ˆ2ï¼‰ç¦æ­¢ä»»ä½•ä¸ªäººæˆ–ç»„ç»‡å°†æ­¤è½¯ä»¶åŠå…¶ç›¸å…³å†…å®¹ç”¨ä½œå•†ä¸šç”¨é€”ï¼Œä½¿ç”¨å¼€æºä»£ç æ—¶å¿…é¡»ä¸¥æ ¼éµå®ˆ MPL-2.0 åè®®ï¼›
    <br/>
    ï¼ˆ3ï¼‰æœ¬è½¯ä»¶åŠå…¶ä»“åº“æ˜¯ Flash Collector å­—æ ·åŠä¸‹å›¾æ‰€ç¤ºå›¾æ ‡ï¼ˆæ¸å˜ç»¿åº•FCå­—ï¼‰çš„æœ€æ—©ä½¿ç”¨è€…ï¼Œä»»ä½•ä¸ªäººæˆ–ç»„ç»‡æœªç»æˆæƒä¸å¾—ä½¿ç”¨ç›¸å…³å­—æ ·æˆ–å›¾æ ‡ã€‚
    <br/><br/>
    <img alt="Icon" src="../assets/favicon.ico" style="height: 50px;width: 50px;margin: 10px 0 0 50%"/>
  </a-card>
  <br/>
  <a-card title="å¼€å‘è€…å·¥å…·">
    <a-button @click="devtool">DevTool</a-button>
  </a-card>
</template>

<script lang="ts" setup>
import type {SelectProps} from 'ant-design-vue';
import {message, Modal} from "ant-design-vue";
import {onMounted, onUnmounted, ref, watch} from "vue";
import bridge from "../bridge";
import {getConfig, setConfig} from "../config";
import {bus} from "../eventbus";
import {shell} from "electron";
import {useRoute, useRouter} from "vue-router";
import {Browser, Config} from "../../../class";
import {Option} from "ts-results";

const router = useRouter(),
    route = useRoute()

const siteOptions = ref<SelectProps['options']>([
  {
    value: "4399",
    label: "4399.com"
  },
  {
    value: "7k7k",
    label: "7k7k.com"
  },
])
let methodOptions = ref([
  {
    value: "baidu",
    label: "ç™¾åº¦é«˜çº§æœç´¢"
  },
  {
    value: "bing",
    label: "å¿…åº”é«˜çº§æœç´¢"
  },
  {
    value: "google",
    label: "è°·æ­Œé«˜çº§æœç´¢"
  },
])

interface ExactBrowser {
  name: string,
  p: string,
  node: Browser
}

let site = ref<string>("4399"),
    method = ref<string>("baidu"),
    libCheck = ref<boolean>(true),
    port = ref<number>(3000),
    oldPort = ref(3000),
    browser = ref<{ flash: ExactBrowser, unity: ExactBrowser, h5: ExactBrowser }>({
      flash: {
        name: "é»˜è®¤æµè§ˆå™¨",
        p: "",
        node: {
          name: "é»˜è®¤æµè§ˆå™¨",
          allowedPaths: [],
          trait: {
            flash: true,
            unity: true,
            debug: "disable"
          }
        }
      },
      unity: {
        name: "é»˜è®¤æµè§ˆå™¨",
        p: "",
        node: {
          name: "é»˜è®¤æµè§ˆå™¨",
          allowedPaths: [],
          trait: {
            flash: true,
            unity: true,
            debug: "disable"
          }
        }
      },
      h5: {
        name: "é»˜è®¤æµè§ˆå™¨",
        p: "",
        node: {
          name: "é»˜è®¤æµè§ˆå™¨",
          allowedPaths: [],
          trait: {
            flash: false,
            unity: false,
            debug: "disable"
          }
        }
      }
    }),
    flashBrowserList = ref<{ label: string, value: string, node: Browser }[]>([]),
    unityBrowserList = ref<{ label: string, value: string, node: Browser }[]>([]),
    h5BrowserList = ref<{ label: string, value: string, node: Browser }[]>([]),
    smartSniffing = ref<Config['smartSniffing']>({
      enable: false,
      port: 9222,
      arg: "--remote-debugging-port="
    }),
    enableProgressBackup = ref(true)

let config: Config

function devtool() {
  bridge('devtool')
}

function getBrowserNode(name: string, list: { label: string, value: string, node: Browser }[]): Browser {
  let b: Browser = {
    name: "é»˜è®¤æµè§ˆå™¨",
    allowedPaths: [],
    trait: {
      flash: true,
      unity: true,
      debug: "disable"
    }
  }
  for (let n of list) {
    if (n.value == name) {
      b = n.node
      break
    }
  }
  return b
}

async function onChangeBrowser(type: 'flash' | 'unity' | 'h5') {
  let name = "", q: Option<string>
  if (type == 'flash') {
    name = browser.value.flash.name
    if (name == "è‡ªå®šä¹‰æµè§ˆå™¨") {
      q = await bridge('chooseBrowser') as Option<string>
    } else {
      q = await bridge('parseBrowserPath', name) as Option<string>
    }
    if (q.some) {
      browser.value.flash.p = q.val
    } else {
      browser.value.flash.name = "é»˜è®¤æµè§ˆå™¨"
      browser.value.flash.p = ""
      smartSniffing.value.enable = false
      name = "é»˜è®¤æµè§ˆå™¨"
    }
    browser.value.flash.node = getBrowserNode(name, flashBrowserList.value)
  } else if (type == 'unity') {
    name = browser.value.unity.name
    if (name == "è‡ªå®šä¹‰æµè§ˆå™¨") {
      q = await bridge('chooseBrowser') as Option<string>
    } else {
      q = await bridge('parseBrowserPath', name) as Option<string>
    }
    if (q.some) {
      browser.value.unity.p = q.val
    } else {
      browser.value.unity.name = "é»˜è®¤æµè§ˆå™¨"
      browser.value.unity.p = ""
      name = "é»˜è®¤æµè§ˆå™¨"
    }
    browser.value.unity.node = getBrowserNode(name, unityBrowserList.value)
  } else {
    name = browser.value.h5.name
    if (name == "è‡ªå®šä¹‰æµè§ˆå™¨") {
      q = await bridge('chooseBrowser') as Option<string>
    } else {
      q = await bridge('parseBrowserPath', name) as Option<string>
    }
    if (q.some) {
      browser.value.h5.p = q.val
    } else {
      browser.value.h5.name = "é»˜è®¤æµè§ˆå™¨"
      browser.value.h5.p = ""
      name = "é»˜è®¤æµè§ˆå™¨"
    }
    browser.value.h5.node = getBrowserNode(name, h5BrowserList.value)
  }
}

watch(site, (a, b) => {
  if (a != "4399" && b == "4399") {
    methodOptions.value.push({
      value: "origin",
      label: "åŸç«™æœç´¢"
    })
  } else if (a == "4399" && b != "4399") {
    methodOptions.value.pop()
    if (method.value == "origin") method.value = "baidu"
  }
})

function validPort(): boolean {
  const p = port.value
  if (p < 1000 || p > 65535) {
    port.value = 3000
    message.error("ç«¯å£æœ‰æ•ˆå€¼èŒƒå›´ï¼š1000-65535")
    return false
  }
  return true
}

function checkSmartSniffing(): boolean {
  if (!smartSniffing.value.enable) return true
  //å®šä¹‰æœ€ç»ˆå˜é‡
  let arg
  //æ£€æŸ¥Flashæµè§ˆå™¨
  const flashDebug = browser.value.flash.node.trait.debug
  //å¤„ç†ä¸å¯ç”¨
  if (flashDebug == "disable") {
    smartSniffing.value.enable = false
    Modal.error({
      title: browser.value.flash.name + "ä¸å¯ç”¨äºæ™ºèƒ½å—…æ¢",
      content: "æ‚¨å½“å‰é€‰æ‹©çš„ Flash å¯åŠ¨æµè§ˆå™¨æ²¡æœ‰å®ç° Chrome DevTools Protocolï¼Œè¯·é‡æ–°é€‰æ‹©ä¸€ä¸ªå¯åŠ¨æµè§ˆå™¨"
    })
    return false
  }
  //å¤„ç†æœªçŸ¥
  if (flashDebug == 'unknown') {
    arg = smartSniffing.value.arg
    if (arg.length < 3 || arg[arg.length - 1] != "=" || arg.match(/\s/)) {
      Modal.error({
        title: "è‡ªå®šä¹‰CDPå‚æ•°æ ¼å¼ä¸è§„èŒƒ",
        content: `è¯·è¾“å…¥${browser.value.flash.name}ä¸å¸¦ç«¯å£å·çš„ Chrome DevTools Protocol å¯åŠ¨å‚æ•°ï¼Œä¾‹å¦‚ --remote-debugging-port=`
      })
      smartSniffing.value.arg = "--remote-debugging-port="
      return false
    }
  } else {
    arg = browser.value.flash.node.trait.debug
  }
  //å¤„ç†ç«¯å£èŒƒå›´
  let port = Number(smartSniffing.value.port)
  if (port < 1000 || port > 65535) {
    Modal.error({
      title: "ç«¯å£èŒƒå›´é”™è¯¯",
      content: `è¯·è¾“å…¥èŒƒå›´åœ¨1000-65535çš„ç«¯å£ï¼Œé»˜è®¤ä¸º9222`
    })
    smartSniffing.value.port = 9222
    return false
  }
  //å†™å¯åŠ¨å‚æ•°
  smartSniffing.value.arg = arg
  smartSniffing.value.port = port
  return true
}

onMounted(async () => {
  config = await getConfig()


  site.value = config.search.site
  method.value = config.search.method

  libCheck.value = config.libCheck

  port.value = config.port
  oldPort.value = config.port

  smartSniffing.value = config.smartSniffing
  enableProgressBackup.value = config.progressBackup.enable

  //è·å–æœ¬åœ°å¯ç”¨æµè§ˆå™¨åˆ—è¡¨
  let bList: Browser[] = [{
    name: "é»˜è®¤æµè§ˆå™¨",
    allowedPaths: [],
    trait: {
      flash: true,
      unity: true,
      debug: 'disable'
    }
  }].concat(await bridge('getAvailableBrowsers'))
  bList.push({
    name: "è‡ªå®šä¹‰æµè§ˆå™¨",
    allowedPaths: [],
    trait: {
      flash: true,
      unity: true,
      debug: 'unknown'
    }
  })
  flashBrowserList.value = bList
      .filter(n => {
        return n.trait.flash
      })
      .map(n => {
        return {
          label: n.name,
          value: n.name,
          node: n
        }
      })
  unityBrowserList.value = bList
      .filter(n => {
        return n.trait.unity
      })
      .map(n => {
        return {
          label: n.name,
          value: n.name,
          node: n
        }
      })
  h5BrowserList.value = bList
      .map(n => {
        return {
          label: n.name,
          value: n.name,
          node: n
        }
      })
  //é…ç½®å½“å‰æµè§ˆå™¨
  const flashBN = await bridge('getBrowserNickName', config.browser.flash),
      unityBN = await bridge('getBrowserNickName', config.browser.unity),
      h5BN = await bridge('getBrowserNickName', config.browser.h5)
  browser.value = {
    flash: {
      name: flashBN,
      p: config.browser.flash,
      node: getBrowserNode(flashBN, flashBrowserList.value)
    },
    unity: {
      name: unityBN,
      p: config.browser.unity,
      node: getBrowserNode(unityBN, unityBrowserList.value)
    },
    h5: {
      name: h5BN,
      p: config.browser.h5,
      node: getBrowserNode(h5BN, h5BrowserList.value)
    }
  }
})

const save = async () => {
  let config = await getConfig()

  config.search.site = site.value
  config.search.method = method.value

  config.libCheck = libCheck.value

  config.port = Number(port.value)

  config.browser = {
    flash: browser.value.flash.p,
    unity: browser.value.unity.p,
    h5: browser.value.h5.p,
    ignoreAlert: config.browser.ignoreAlert
  }

  config.smartSniffing = JSON.parse(JSON.stringify(smartSniffing.value))
  config.progressBackup.enable = enableProgressBackup.value

  setConfig(config, true)
  bus.emit('update-search-pattern')
}

onUnmounted(save)

router.beforeEach(() => {
  //æ£€æŸ¥ç«¯å£å·
  if (!validPort()) {
    return false
  }
  //æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«ä¿®æ”¹
  if (route.path == '/setting' && oldPort.value != port.value) {
    Modal.confirm({
      title: "éœ€è¦é‡å¯åº”ç”¨",
      content: "æ‚¨æ›´æ”¹äº†æ¸¸æˆæœåŠ¡ç«¯å£ï¼Œåœ¨è®¿é—®å…¶ä»–é¡µé¢ä¹‹å‰éœ€è¦é‡å¯åº”ç”¨",
      okText: "é‡å¯",
      cancelText: "å–æ¶ˆ",
      onOk() {
        restart()
      },
      onCancel() {
        port.value = oldPort.value
      }
    })
    return false
  }
  //æ£€æŸ¥æ™ºèƒ½å—…æ¢å‚æ•°æ˜¯å¦æœ‰æ•ˆ
  if (smartSniffing.value.enable && !checkSmartSniffing()) {
    return false
  }
  //æ”¾è¡Œè·¯ç”±
  return true
})

async function restart() {
  if (validPort()) {
    await save()
    bridge('restart')
  }
}

</script>

<style scoped>
a-card {
  width: 100%;
}

.browser-selector {
  width: 160px;
}

.browser-location {
  color: gray;
}
</style>
